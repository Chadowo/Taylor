#!/usr/bin/env bash

bundle exec rake linux:release:build windows:release:build docker:build:export:web
rm -rf exports
mkdir -p exports
taylor-dev export

export DISPLAY=:1

Xvfb :1 -screen 0 1280x800x24 &
export XVFB_PID=$!

echo XVFB_PID: $XVFB_PID

DISPLAY=:1 openbox &
export OPENBOX_PID=$!

../dist/linux/release/taylor ../cli-tool/cli.rb test.rb
export NATIVE_EXIT_CODE=$?
wine ../dist/windows/release/taylor.exe ../cli-tool/cli.rb test.rb
export WINE_EXIT_CODE=$?

pushd exports
unzip taylor-test-suite-web-v0.0.1.zip
../../.buildkite/scripts/tests/web_test.rb
export WEB_EXIT_CODE=$?

popd


kill $OPENBOX_PID &> /dev/null
kill $XVFB_PID &> /dev/null

echo "Linux: $NATIVE_EXIT_CODE"
echo "Wine: $WINE_EXIT_CODE"
echo "Web: $WEB_EXIT_CODE"

exit $NATIVE_EXIT_CODE || $WINE_EXIT_CODE || $WEB_EXIT_CODE
